#!/bin/bash
# Nova Pre-Push Hook
# Runs comprehensive tests before push. Blocks push if tests fail.
#
# To install: git config core.hooksPath .githooks

set -e

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo -e "${YELLOW}Running pre-push checks...${NC}"

cd bootstrap

# Check 1: All tests
echo -e "\n${YELLOW}[1/3] Running all tests...${NC}"
if ! cargo test; then
    echo -e "${RED}FAILED: Tests failed${NC}"
    exit 1
fi
echo -e "${GREEN}All tests passed ($(cargo test 2>&1 | grep -o '[0-9]* passed' | head -1))${NC}"

# Check 2: Security tests specifically
echo -e "\n${YELLOW}[2/3] Running security tests...${NC}"
if ! cargo test span_attack; then
    echo -e "${RED}FAILED: Span security tests failed${NC}"
    exit 1
fi
if ! cargo test token_attack; then
    echo -e "${RED}FAILED: Token security tests failed${NC}"
    exit 1
fi
echo -e "${GREEN}Security tests passed${NC}"

# Check 3: Size guarantees
echo -e "\n${YELLOW}[3/3] Verifying size guarantees (ADR-004)...${NC}"
if ! cargo test token_is_12_bytes; then
    echo -e "${RED}FAILED: Token size guarantee broken!${NC}"
    exit 1
fi
if ! cargo test token_kind_is_1_byte; then
    echo -e "${RED}FAILED: TokenKind size guarantee broken!${NC}"
    exit 1
fi
if ! cargo test span_is_8_bytes; then
    echo -e "${RED}FAILED: Span size guarantee broken!${NC}"
    exit 1
fi
echo -e "${GREEN}Size guarantees verified${NC}"

echo -e "\n${GREEN}All pre-push checks passed! Safe to push.${NC}"
